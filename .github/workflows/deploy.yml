name: Deploy

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Criar arquivo de deploy
        run: |
          git archive --format=tar.gz -o deploy.tar.gz HEAD

      - name: Subir arquivos para o servidor
        uses: appleboy/scp-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USERNAME }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT }}
          source: "deploy.tar.gz"
          target: "/opt/iscout-api/"

      - name: Extrair e subir servi√ßos
        uses: appleboy/ssh-action@v1.2.2
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USERNAME }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT }}
          script: |
            cd /opt/iscout-api

            tar -xzf deploy.tar.gz
            rm deploy.tar.gz

            docker compose -f docker-compose.prod.yml build --no-cache
            docker compose -f docker-compose.prod.yml up -d

            find . -mindepth 1 -maxdepth 1 ! -name 'docker-compose.prod.yml' ! -name '.env.app' ! -name '.env.database' -exec rm -rf {} +

            yes | docker system prune -a
